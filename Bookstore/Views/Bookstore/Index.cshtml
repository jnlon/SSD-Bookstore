@using Bookstore.Utilities
@{
    ViewData["Title"] = "Home Page";
    SearchQueryResult searchResult = (ViewData["Search"] as SearchQueryResult)!;
    Settings settings = (ViewData["Settings"] as Settings)!;
    int pageNumber = (int)ViewData["PageNumber"];
    int maxPageNumber = (int)ViewData["MaxPageNumber"];
    SearchQuery search = searchResult.Search;
    
    string TruncateTitle(string text)
    {
        return text.Length > 115
            ? text.Substring(0, 115) + "..."
            : text;
    }
    
    string? navDisableStart = pageNumber == 1 ? "disabled" : null;
    string? navDisableEnd = pageNumber == maxPageNumber ? "disabled" : null;
}

<div class="m-4">
    <!-- Query Bar -->
    <div class="bg-light p-2">
        <form method="get" asp-route="Index">
            <fieldset class="d-flex justify-content-between">
                <input style="width: 84%" name="search" type="text" class="form-control d-inline-block" value="@search.QueryString" placeholder="Bookmark Query">
                <input style="width: 15%" type="submit" class="d-inline-block">
            </fieldset>
        </form>
    </div>

    <form method="post">
        <!-- Table Controls -->
        <span class="font-weight-bold">Bookmark Actions</span>
        
        <div class="d-flex justify-content-between my-2">
            <div class="w-50">
                <input id="bookstore-control-archive" type="submit" name="action" class="btn btn-primary" value="Archive">
                <input id="bookstore-control-edit" type="submit" name="action" class="btn btn-primary" value="Edit">
                <input id="bookstore-control-delete" type="submit" name="action" class="btn btn-danger" value="Delete">
                <button id="bookstore-control-select-all" type="button"  class="btn btn-success">Select All</button>
            </div>
            
            <div class="d-flex justify-content-end w-50">
                <!--
                <select class="form-control d-inline-block" style="width:10em">
                    <option selected>Sort By...</option>
                    <option>Date Created</option>
                    <option>URL</option>
                    <option>Title</option>
                    <option>Folder</option>
                    <option>Tags</option>
                </select>
                -->
                <input id="bookstore-control-filter" class="form-control d-inline-block w-50" type="text" placeholder="Filter Bookmarks">
                <a class="ml-2 btn btn-success" asp-controller="Bookmarks" asp-action="Create">New Bookmark</a>
            </div>
        </div>
        
        <div>
            Showing @searchResult.QueriedBookmarks of @searchResult.TotalBookmarks bookmarks.
        </div>
        
        <div>
            <nav class="text-center justify-content-around d-flex justify-content-between mx-auto w-100">
                <ul class="pagination d-inline-flex">
                    <li class="page-item @navDisableStart">
                        <a class="page-link " asp-controller="Bookstore" asp-action="Index" asp-route-search="@search.QueryString" asp-route-page="@Math.Max(pageNumber - 1, 1)">Previous</a>
                    </li>
                </ul>
                <ul class="pagination d-inline-flex w-100 justify-content-center">
                    <li class="page-item @navDisableStart">
                        <a class="page-link" asp-controller="Bookstore" asp-action="Index" asp-route-search="@search.QueryString" asp-route-page="page">&laquo;</a>
                    </li>
                    @for (int pn = Math.Max(1, pageNumber - 5); pn <= Math.Min(pageNumber + 5, maxPageNumber); pn++)
                    {
                        <li class="page-item @(pageNumber == pn ? "active" : "")">
                            <a class="page-link" asp-controller="Bookstore" asp-action="Index" asp-route-search="@search.QueryString" asp-route-page="@pn">@pn</a>
                        </li>
                    }
                    <li class="page-item @navDisableEnd">
                        <a class="page-link" asp-controller="Bookstore" asp-action="Index" asp-route-search="@search.QueryString" asp-route-page="@maxPageNumber">&raquo;</a>
                    </li>
                </ul>
                <ul class="pagination d-inline-flex">
                    <li class="page-item @navDisableEnd">
                        <a class="page-link" asp-controller="Bookstore" asp-action="Index" asp-route-search="@search.QueryString" asp-route-page="@Math.Min(pageNumber + 1, maxPageNumber)">Next</a>
                    </li>
                </ul>
            </nav>
        </div>
        
        <!-- Main Table -->
        <table id="bookstore-table" class="table table-sm">
            <thead>
            <tr style="white-space: nowrap">
                <th class="text-center">Select</th>
                <th class="text-center">
                    <a
                        title="Sort by Folder"
                        asp-controller="Bookstore"
                        asp-action="Index"
                        asp-route-page="1"
                        asp-route-search="@search.QueryString sort(folder, @(search.SortField == SearchQueryField.Folder && !search.SortDescending ? "desc" : "asc"))">
                        Folder &#x296E;
                    </a>
                </th>
                <th>
                    <a
                        title="Sort by Bookmark"
                        href="?search=sort(title, @(search.SortField == SearchQueryField.Title && !search.SortDescending ? "desc" : "asc"))">
                        Bookmark &#x296E;
                    </a>
                </th>
                <th class="text-center">
                    <a
                        title="Sort by Tag"
                        href="?search=sort(tag, @(search.SortField == SearchQueryField.Tag && !search.SortDescending ? "desc" : "asc"))">
                        Tags &#x296E;
                    </a>
                </th>
                <th class="text-center">
                    <a
                        title="Sort by Archive Status"
                        href="?search=sort(archived, @(search.SortField == SearchQueryField.Archived && !search.SortDescending ? "desc" : "asc"))">
                        Archive &#x296E;
                    </a>
                </th>
            </tr>
            </thead>
            <tbody id="bookstore-table-body">
                @foreach (var bookmark in searchResult.Results)
                {
                    var bookmarkFolders = bookmark.Folder?.ToArray() ?? new Folder[] {};
                    <tr>
                        <td class="text-center align-middle">
                            <input type="checkbox" class="form-check mx-auto" style="height: 1.5em; width: 1.5em;" name="selected" value="@bookmark.Id" id="@bookmark.Id">
                        </td>
                        <td class="text-center align-middle">
                            @if (bookmarkFolders.Length == 0)
                            {
                                <span>No Folder</span>
                            }
                            @foreach (var folder in bookmarkFolders)
                            {
                                <a href="?search=folders(@folder.ToMenuString())" class="bookstore-table-folder">@folder.Name</a>
                                @if (folder.Id != bookmarkFolders.Last().Id)
                                {
                                    <span>&gt;</span>
                                }
                            }
                        </td> 
                        <td class="align-middle">
                            @if (bookmark.Favicon != null)
                            {
                                <img style="width: 1.5em; height: 1.5em;" src="~/Bookmarks/Favicon/@bookmark.Id">
                            }
                            <a href="@bookmark.Url" class="bookstore-table-link" title="@bookmark.Title">@TruncateTitle(bookmark.Title)</a>
                        </td>
                        <td class="text-center align-middle">
                            @{ var sortedBookmarkTags = bookmark.Tags?.OrderBy(t => t.Name).ToList() ?? new List<Tag>();}
                            @foreach (var tag in sortedBookmarkTags)
                            {
                                <a class="bookstore-table-tag" href="?search=tag(@tag.Name)">@tag.Name</a><span>@(tag != sortedBookmarkTags.Last() ? "," : "")</span>
                            }
                        </td>
                        <td class="text-center align-middle">
                            @if (bookmark.Archive != null) 
                            {
                                <a href="#">Archive Link</a>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
        
        <div>
            <nav class="text-center justify-content-around d-flex justify-content-between mx-auto w-100">
                <ul class="pagination d-inline-flex">
                    <li class="page-item @navDisableStart">
                        <a class="page-link " asp-controller="Bookstore" asp-action="Index" asp-route-search="@search.QueryString" asp-route-page="@Math.Max(pageNumber - 1, 1)">Previous</a>
                    </li>
                </ul>
                <ul class="pagination d-inline-flex w-100 justify-content-center">
                    <li class="page-item @navDisableStart">
                        <a class="page-link" asp-controller="Bookstore" asp-action="Index" asp-route-search="@search.QueryString" asp-route-page="page">&laquo;</a>
                    </li>
                    @for (int pn = Math.Max(1, pageNumber - 5); pn <= Math.Min(pageNumber + 5, maxPageNumber); pn++)
                    {
                        <li class="page-item @(pageNumber == pn ? "active" : "")">
                            <a class="page-link" asp-controller="Bookstore" asp-action="Index" asp-route-search="@search.QueryString" asp-route-page="@pn">@pn</a>
                        </li>
                    }
                    <li class="page-item @navDisableEnd">
                        <a class="page-link" asp-controller="Bookstore" asp-action="Index" asp-route-search="@search.QueryString" asp-route-page="@maxPageNumber">&raquo;</a>
                    </li>
                </ul>
                <ul class="pagination d-inline-flex">
                    <li class="page-item @navDisableEnd">
                        <a class="page-link" asp-controller="Bookstore" asp-action="Index" asp-route-search="@search.QueryString" asp-route-page="@Math.Min(pageNumber + 1, maxPageNumber)">Next</a>
                    </li>
                </ul>
            </nav>
        </div>
        
    </form>

</div>

